import{P as L}from"./PicoView-CPztt05D.js";import{S as q,a as T}from"./SelectionManager-CMotajaX.js";import{g as A,A as i,p as w,o as v,t as f,r as S}from"./domHelpers-Bl1jAPjX.js";import{G as k,a as D}from"./Grid-DRax1VmO.js";document.addEventListener("DOMContentLoaded",async()=>{const a=document.getElementById("grid"),o=document.getElementById("album").dataset.albumId;new q(a);const l=new F(o),u=new L(a);l.init(),B(u,l),P(a,u),addFolderFolder=new T({container:"addFolderFolder",apiUrl:route("api.folders.search")}),r("addFolderToAlbumForm","PUT",n=>route("api.albums.photos.addFromFolder",{album:n.album_id}),(n,t)=>route("albums.show",{album:t.album_id})),r("updateAlbumForm","PATCH",n=>route("api.albums.update",{album:o}),(n,t)=>window.location.href);function r(n,t="POST",d,e){const c=document.getElementById(n);c.addEventListener("submit",async function(h){if(h.preventDefault(),!c.checkValidity())return c.reportValidity();c.querySelectorAll("button").forEach(m=>m.disabled=!0);try{const m=A(c),I=await i.request(d(m),t,m);c.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=e(I,m)},1e3)}catch(m){console.error(m)}}),c.reset()}document.getElementById("offcanvasUpdateAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=route("api.albums.show",{album:o}),d=await i.request(t,"GET");w(document.getElementById("updateAlbumForm"),d.data)}catch(t){console.error(t)}v("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=p.getAttribute("data-album-id"),d=await i.request(route("api.albums.tokens",{album:t}),"GET"),e=document.getElementById("tokenList");d.data.forEach(c=>{e.appendChild(s(c))})}catch(t){console.error(t)}}),document.getElementById("multiDeleteBtn").addEventListener("click",async function(n){n.preventDefault();try{alert("Pending implementation")}catch(t){console.error(t)}});const p=document.getElementById("generateTokenBtn");p.addEventListener("click",async function(n){n.preventDefault();try{const t=p.getAttribute("data-album-id"),d=await i.request(route("api.tokens.store"),"POST",{album_id:t});document.getElementById("tokenList").appendChild(s(d.data))}catch(t){console.error(t)}});function s(n){const t=route("albums.show",{album:n.album_id,token:n.token}),e=document.getElementById("tokenTpl").content.cloneNode(!0);e.querySelector("input").value=t,e.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),e.querySelector(".expires_at").value=n.expires_at,e.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t):(h.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),f("Copied to clipboard")});const h=e.querySelector(".btn-delete");return h.addEventListener("click",()=>{i.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),h.closest(".token-wrapper").remove(),f("Share link has been deleted")}),e}function B(n,t){const d={"photo.more":e=>t.showMore(),"photo.info":e=>t.viewInfo(e.detail.id),"photo.cover":e=>t.setCover(e.detail.id),"photo.download":e=>t.forceDownload(e.detail.id),"photo.remove":e=>{t.remove(e.detail.id),n.next()},"photo.shown":e=>t.recordView(e.detail.id)};for(const[e,c]of Object.entries(d))n.addEventListener(e,c)}function P(n,t){Object.entries({"grid.refresh":e=>t.refresh(e.detail),"selection.start":e=>t.disable(),"selection.stop":e=>t.enable()}).forEach(([e,c])=>{n.addEventListener(e,c)})}});class F{constructor(a){this.id=a,this.grid=new k(this),this.loader=new x(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const o=(await this.loader.next()).map(async u=>{const r=await D.photo(u);return r.querySelector(".btn-delete").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.remove(u.id)}),r.querySelector(".btn-info").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.viewInfo(u.id)}),r.querySelector(".btn-cover").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.setCover(u.id)}),r.querySelector(".btn-download").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.forceDownload(u.id)}),r}),l=await Promise.all(o);this.grid.add(l)}}async recordView(a){try{const o=route("api.photos.impression",{photo:a});await i.request(o,"POST")}catch(o){console.error(o)}}async viewInfo(a){try{const o=route("api.photos.show",{photo:a}),l=await i.request(o,"GET");w(document.getElementById("infoForm"),{dimensions:`${l.data.width} x ${l.data.height}`,...l.data})}catch(o){console.error(o)}v("offcanvas-info")}forceDownload(a){const o=route("photos.download",{photo:a});window.location.href=o}async setCover(a){try{const o=route("api.albums.update",{album:this.id});await i.request(o,"PATCH",{photo_id:a}),f("Album cover set")}catch(o){console.error(o)}}async remove(a){const o=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await i.request(r,"DELETE")}catch(r){console.error(r)}const l=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(o),l.show();const u=document.getElementById("btn-undo");S(u).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await i.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(o),l.hide()})}}class x{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||i.isLoading(this.albumId))return[];try{const o=await i.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=o.meta.current_page,this.lastPage=o.meta.last_page,o.data}catch(o){console.error(o)}return[]}}
