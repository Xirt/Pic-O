import{d as x}from"./domHelpers-BH3uQtD-.js";import{A as O}from"./AppRequest-BAjaqpDZ.js";class W{constructor(t){this.sleep=e=>new Promise(o=>setTimeout(o,e)),this.container=t,this.processing=!1,this.queue=[],this.items=[],this.breakpoints=this.parseDataCols(this.container.dataset.cols||""),this.currentColCount=0,this.setupColumns(),window.addEventListener("resize",()=>this.refreshColumns())}parseDataCols(t){const e={sm:null,md:null,lg:null,xl:null};t.split(" ").forEach(c=>{const[l,h]=c.split(":");l&&h&&(e[l]=parseInt(h))});const o=["sm","md","lg","xl"];for(let c=0;c<o.length;c++)e[o[c]]===null&&(e[o[c]]=c>0?e[o[c-1]]:1);return e}getColumnCount(){const t=window.innerWidth;switch(!0){case t>=1200:return this.breakpoints.xl;case t>=992:return this.breakpoints.lg;case t>=768:return this.breakpoints.md}return this.breakpoints.sm}setupColumns(){this.container.innerHTML="";const t=this.getColumnCount();this.currentColCount=t;const e=(100/t).toFixed(6)+"%";for(let o=0;o<t;o++){const c=document.createElement("div");c.className="col flow p-1",c.style.width=e,this.container.appendChild(c)}}refreshColumns(t=!1){const e=this.getColumnCount();if(t||e!==this.currentColCount){const o=[...this.items];this.clear(),this.setupColumns(),o.forEach(c=>this.addItem(c))}}queueItem(t){this.queue.push(t),this.processQueue()}async processQueue(){if(!this.processing){for(this.processing=!0;this.queue.length>0;){const t=this.queue.shift();this.addItem(t),await this.sleep(100)}this.container.dispatchEvent(new CustomEvent("grid.complete",{})),this.processing=!1}}addItem(t){this.getShortestColumn().appendChild(t),this.items.push(t),this.container.dispatchEvent(new CustomEvent("grid.refresh",{})),requestAnimationFrame(()=>{requestAnimationFrame(()=>{t.classList.add("show")})})}removeItem(t){t.classList.remove("show"),setTimeout(()=>{t.parentElement&&t.parentElement.removeChild(t),this.items=this.items.filter(e=>e!==t),this.refreshColumns(!0)},300)}getShortestColumn(){return Array.from(this.container.querySelectorAll(".flow")).reduce((e,o)=>o.scrollHeight<e.scrollHeight?o:e)}clear(){this.items=[],this.queue=[],this.container.querySelectorAll(".flow").forEach(e=>e.innerHTML="")}}const L=(function(a){const t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],e=n=>{let s=0;for(let r=0;r<n.length;r++){const i=n[r],d=t.indexOf(i);s=s*83+d}return s},o=(n,s)=>{var r="";for(let i=1;i<=s;i++){let d=Math.floor(n)/Math.pow(83,s-i)%83;r+=t[Math.floor(d)]}return r},c=n=>{let s=n/255;return s<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)},l=n=>{let s=Math.max(0,Math.min(1,n));return s<=.0031308?Math.round(s*12.92*255+.5):Math.round((1.055*Math.pow(s,.4166666666666667)-.055)*255+.5)},h=n=>n<0?-1:1,w=(n,s)=>h(n)*Math.pow(Math.abs(n),s),M=n=>{if(!n||n.length<6)throw new Error("The blurhash string must be at least 6 characters");const s=e(n[0]),r=Math.floor(s/9)+1,i=s%9+1;if(n.length!==4+2*i*r)throw new Error(`blurhash length mismatch: length is ${n.length} but it should be ${4+2*i*r}`)},I=n=>{const s=n>>16,r=n>>8&255,i=n&255;return[c(s),c(r),c(i)]},E=(n,s)=>{const r=Math.floor(n/361),i=Math.floor(n/19)%19,d=n%19;return[w((r-9)/9,2)*s,w((i-9)/9,2)*s,w((d-9)/9,2)*s]},R=(n,s,r,i)=>{let d=0,g=0,u=0;const v=s*4;for(let C=0;C<s;C++)for(let f=0;f<r;f++){const p=i(C,f);d+=p*c(n[4*C+0+f*v]),g+=p*c(n[4*C+1+f*v]),u+=p*c(n[4*C+2+f*v])}let y=1/(s*r);return[d*y,g*y,u*y]},H=n=>{const s=l(n[0]),r=l(n[1]),i=l(n[2]);return(s<<16)+(r<<8)+i},F=(n,s)=>{let r=Math.floor(Math.max(0,Math.min(18,Math.floor(w(n[0]/s,.5)*9+9.5)))),i=Math.floor(Math.max(0,Math.min(18,Math.floor(w(n[1]/s,.5)*9+9.5)))),d=Math.floor(Math.max(0,Math.min(18,Math.floor(w(n[2]/s,.5)*9+9.5))));return r*19*19+i*19+d};return a.decodePromise=(n,s,r,i=1)=>new Promise((d,g)=>{d(a.decode(n,s,r,i))}),a.decode=(n,s,r,i=1)=>{M(n),i=i|1;const d=e(n[0]),g=Math.floor(d/9)+1,u=d%9+1,y=(e(n[1])+1)/166,C=new Array(u*g);for(let m=0;m<C.length;m++)if(m===0){const b=e(n.substring(2,6));C[m]=I(b)}else{const b=e(n.substring(4+m*2,6+m*2));C[m]=E(b,y*i)}const f=s*4,p=new Uint8ClampedArray(f*r);for(let m=0;m<r;m++)for(let b=0;b<s;b++){let k=0,N=0,P=0;for(let B=0;B<g;B++)for(let q=0;q<u;q++){const A=Math.cos(Math.PI*b*q/s)*Math.cos(Math.PI*m*B/r);let D=C[q+B*u];k+=D[0]*A,N+=D[1]*A,P+=D[2]*A}let T=l(k),_=l(N),G=l(P);p[4*b+0+m*f]=T,p[4*b+1+m*f]=_,p[4*b+2+m*f]=G,p[4*b+3+m*f]=255}return p},a.encodePromise=(n,s,r,i,d)=>new Promise((g,u)=>{g(a.encode(n,s,r,i,d))}),a.encode=(n,s,r,i,d)=>{if(i<1||i>9||d<1||d>9)throw new Error("BlurHash must have between 1 and 9 components");if(s*r*4!==n.length)throw new Error("Width and height must match the pixels array");let g=[];for(let p=0;p<d;p++)for(let m=0;m<i;m++){const b=m==0&&p==0?1:2,k=R(n,s,r,(N,P)=>b*Math.cos(Math.PI*m*N/s)*Math.cos(Math.PI*p*P/r));g.push(k)}const u=g[0],v=g.slice(1);let y="",C=i-1+(d-1)*9;y+=o(C,1);let f;if(v.length>0){let p=Math.max(...v.map(b=>Math.max(...b))),m=Math.floor(Math.max(0,Math.min(82,Math.floor(p*166-.5))));f=(m+1)/166,y+=o(m,1)}else f=1,y+=o(0,1);return y+=o(H(u),4),v.forEach(p=>{y+=o(F(p,f),2)}),y},a.getImageData=n=>{const s=n.width,r=n.height,i=document.createElement("canvas"),d=i.getContext("2d");return i.width=s,i.height=r,d.width=s,d.height=r,d.drawImage(n,0,0),d.getImageData(0,0,s,r).data},a.drawImageDataOnNewCanvas=(n,s,r)=>{const i=document.createElement("canvas"),d=i.getContext("2d");return i.width=s,i.height=r,d.width=s,d.height=r,d.putImageData(new ImageData(n,s,r),0,0),i},a.getImageDataAsImageWithOnloadPromise=(n,s,r)=>new Promise((i,d)=>{a.getImageDataAsImage(n,s,r,(g,u)=>{i(u)})}),a.getImageDataAsImage=(n,s,r,i)=>{const g=a.drawImageDataOnNewCanvas(n,s,r).toDataURL(),u=new Image(s,r);return u.onload=v=>i(v,u),u.width=s,u.height=r,u.src=g,u},a})({});class z{constructor(t,e="grid"){this.sleep=o=>new Promise(c=>setTimeout(c,o)),this.container=typeof e=="string"?document.getElementById(e):e,this.manager=t,this.rendering=!1,this.observer=!0,this.items=[],this.masonry=new W(this.container),this.container.addEventListener("grid.complete",()=>{this.observer&&this.setupObserver()})}add(t){const e=Array.isArray(t)?t:[t];this.items=this.items.concat(e),this.render()}async render(){if(!this.rendering){for(this.rendering=!0;this.items.length;)this._append(this.items.shift());this.rendering=!1}}_append(t){this.masonry.queueItem(t),this.container.dispatchEvent(new CustomEvent("grid.queued_item",{detail:{item:t}}))}remove(t){this.masonry.removeItem(t)}clear(){this.masonry.clear(),this.items=[]}setupObserver(){const t=this.container.querySelectorAll(".grid-item");if(!t.length)return;new IntersectionObserver(async(o,c)=>{for(const l of o)l.isIntersecting&&!O.isLoading()&&(c.disconnect(),await this.manager.showMore())},{rootMargin:"200px"}).observe(t[t.length-1])}}const U={folder(a){const t=document.createElement("div");t.className="grid-item card folder selectable clickable my-1";const e=document.createElement("div");e.className="card-body text-primary position-relative w-100 ratio ratio-4x3 p-3",t.appendChild(e);const o=document.createElement("div");o.className="d-flex align-items-center justify-content-center";const c=document.createElement("img");c.className="h-75 w-75",c.src="images/folder.png",o.appendChild(c);const l=document.createElement("img");l.className="position-absolute w-75 mt-2",l.src=`folders/${a.id}/thumbnail`,o.appendChild(l),e.appendChild(o);const h=document.createElement("div");return h.className="card-footer text-center text-truncate overflow-hidden",h.textContent=a.name,h.title=a.name,t.appendChild(h),t},photoFolder(a,t){const e=document.createElement("a");e.href=a.path_full,e.setAttribute("data-id",a.id),e.setAttribute("data-type","image"),e.className="grid-item card file selectable clickable thumbnail my-1";const o=document.createElement("div");o.className="card-body text-primary position-relative w-100 ratio ratio-4x3 p-3",o.style.backgroundImage=`url(${a.path_thumb})`,o.style.backgroundSize="cover",e.appendChild(o);const c=document.createElement("div");c.className="d-flex align-items-center justify-content-center";const l=x("check-circle-fill","opacity-75");c.appendChild(l),o.appendChild(c);const h=document.createElement("div");return h.className="card-footer text-center text-truncate overflow-hidden",h.textContent=a.filename+a.filename,h.title=a.filename,e.appendChild(h),e},async photo(a,t=!0){const e=Math.min(250/a.width,1),o=Math.round(a.width*e),c=Math.round(a.height*e),l=document.createElement("a");l.id=`card-${a.id}`,l.href=a.path_full,l.setAttribute("data-id",a.id),l.setAttribute("data-type","image"),l.style.cssText=`width: 100%; aspect-ratio: ${o} / ${c};`,l.className="grid-item clickable selectable position-relative thumbnail w-100 p-0 my-1";const h=x("check-circle-fill","position-absolute top-50 start-50 translate-middle");l.appendChild(h);const w=document.createElement("div");w.className="img-container text-primary position-relative d-inline-block align-items-center text-center";const M=await this._createBlurHash(a,o,c);M.className="d-block w-100 h-100 m-0 blurhash",M.removeAttribute("height"),M.removeAttribute("width"),l.appendChild(M);const I=document.createElement("img");I.className="d-block w-100 h-100 opacity-0 m-0",I.src=a.path_thumb,l.appendChild(I);const E=document.createElement("div");return E.className="d-block card-img-overlay bg-dark text-light fw-semibold quick-actions top p-1",l.appendChild(E),E.appendChild(this.createInfoButton(l)),E.appendChild(this.createDownloadButton(l)),t&&(E.appendChild(this.createCoverButton(l)),E.appendChild(this.createDeleteButton(l))),I.onload=()=>{I.classList.remove("opacity-0"),M.classList.add("opacity-0"),setTimeout(()=>l.removeChild(M),1e3)},l},async album(a){const t=document.createElement("a");if(t.className="grid-item card clickable selectable position-relative rounded-0 ratio ratio-4x3 w-100 p-0 my-1 border-0",t.href=route("albums.show",{id:a.id}),t.setAttribute("data-id",a.id),a.cover){const h=await this._createBlurHash(a.cover);h.className="d-block position-absolute object-fit-cover w-100 h-100",t.appendChild(h);const w=document.createElement("img");w.className="d-block object-fit-cover",w.src=`photos/${a.cover.id}/thumbnail`,w.loading="lazy",t.appendChild(w)}const e=x("check-circle-fill","opacity-75 h-auto w-auto position-absolute top-50 start-50 translate-middle");t.appendChild(e);const o=document.createElement("div");o.className="card-img-overlay bottom badge rounded-pill bg-secondary text-light fw-bold px-2 py-1 m-1 me-2",o.textContent=a.photos,t.appendChild(o);const c=document.createElement("div");c.className="card-img-overlay top rounded-0 bg-dark text-light fw-semibold text-truncate p-2",c.textContent=a.name,t.appendChild(c);const l=document.createElement("div");return l.className="d-block quick-actions p-1 pe-2",t.appendChild(l),l.appendChild(this.createModifyButton(t)),l.appendChild(this.createDeleteButton(t)),t},separator(a){const t=document.createElement("h5");return t.className="text-dark-emphasis p-2 pb-1 mt-4 fw-semibold border-bottom",t.innerText=a,t},createInfoButton(a){const t=document.createElement("button");t.className="btn btn-light btn-sm me-1 btn-info";const e=x("info-circle-fill","text-secondary");return t.appendChild(e),t},createDownloadButton(a){const t=document.createElement("button");t.className="btn btn-light btn-sm me-1 btn-download";const e=x("download","text-secondary");return t.appendChild(e),t},createCoverButton(a){const t=document.createElement("button");t.className="btn btn-light btn-sm me-1 btn-cover no-share";const e=x("star-fill","text-secondary");return t.appendChild(e),t},createModifyButton(a){const t=document.createElement("button");t.className="btn btn-light btn-sm me-1 btn-modify no-share";const e=x("pencil-fill","text-secondary");return t.appendChild(e),t},createDeleteButton(a){const t=document.createElement("button");t.className="btn btn-light btn-sm btn-delete no-share";const e=x("trash3","text-secondary");return t.appendChild(e),t},async _createBlurHash(a,t=250,e=250){let o=a.blurhash;return o=typeof o=="string"&&o.length>=6?o:"LFRf8~-;?.OF?Hf8ShkB%vWrIEs9",await L.getImageDataAsImageWithOnloadPromise(L.decode(o,t,e),t,e)}};export{z as G,W as M,U as a};
