import{P as y}from"./PicoView-iUxXwDXZ.js";import{S as E}from"./Selection-BoYlDC7p.js";import{A as d}from"./AppRequest-BAjaqpDZ.js";import{G as I,a as g}from"./Grid-B13L45IR.js";import{S as v}from"./SelectionManager-BSsIT1AF.js";import{g as L,p as b,o as _}from"./domHelpers-0caSGQTr.js";document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("grid"),t=new F(new E(e)),n=new y(e);t.init(),c(n,t),u(e,n),w("offcanvas-create-album"),w("offcanvas-update-album"),P("createAlbumForm","POST",a=>route("api.albums.store"),a=>route("albums.show",{album:a.data.id})),P("updateAlbumForm","PUT",a=>route("api.album.photos.addMultiple",{album:a.album_id}),(a,r)=>route("albums.show",{album:r.album_id})),new v({elements:{input:"dropdownInput",menu:"dropdownMenu",container:"search-dropdown-container",hiddenInput:"dropdownHidden"},apiUrl:route("api.albums.search"),renderItem:null});function c(a,r){const i={"photo.more":s=>r.showMore(),"photo.info":s=>r.viewInfo(s.detail.id),"photo.download":s=>r.forceDownload(s.detail.id)};for(const[s,o]of Object.entries(i))a.addEventListener(s,o)}function u(a,r){Object.entries({"grid.refresh":s=>r.refresh(),"selection.start":s=>r.disable(),"selection.stop":s=>r.enable()}).forEach(([s,o])=>{a.addEventListener(s,o)})}function w(a,r=".container-hidden"){const i=document.getElementById(a);i.addEventListener("show.bs.offcanvas",()=>{const s=e.querySelectorAll(".selected"),o=Array.from(s).map(h=>h.dataset.id),f=i.querySelector(r);f.innerHTML="",o.forEach(h=>{const m=document.createElement("input");m.name="pictures",m.type="hidden",m.value=h,f.appendChild(m)});const l=i.querySelector(".picture-count");l.textContent=o.length})}function P(a,r="POST",i,s){const o=document.getElementById(a);o.addEventListener("submit",async function(f){if(f.preventDefault(),!o.checkValidity())return o.reportValidity();try{const l=L(o),h=await d.request(i(l),r,l,"albums");o.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=s(h,l)},1e3)}catch(l){console.error(l)}})}});class F{constructor(e){this.selector=e,this.grid=new I(this),this.folderLoader=new x,this.photoLoader=new S}async init(){this.loading=!1;const e=await this.folderLoader.getFolder();this._setParent(e.parent_id),this._setName(e.name),this._setId(e.id),await this.showMore()}isLoading(){return this.loading}async showMore(){if(this.loading=!0,this.folderLoader.hasNextPage()){const t=(await this.folderLoader.next()).map(c=>{const u=g.folder(c,this);return u.addEventListener("click",async()=>{this.setFolder(c.id)}),u}),n=await Promise.all(t);this.grid.add(n)}if(!this.folderLoader.hasNextPage()){const t=(await this.photoLoader.next()).map(c=>g.photoFolder(c,this)),n=await Promise.all(t);this.grid.add(n)}this.loading=!1}async viewInfo(e){try{const t=route("api.photos.show",{photo:e}),n=await d.request(t,"GET");b(document.getElementById("infoForm"),{dimensions:`${n.data.width} x ${n.data.height}`,...n.data})}catch(t){console.error(t)}_("offcanvas-info")}forceDownload(e){const t=route("photos.download",{photo:e});window.location.href=t}async setFolder(e){this.selector.cancelSelection(),this.grid.clear(),this._setId(e),this.init()}_setName(e){document.getElementById("title").innerHTML=e}_setParent(e){if(e!=null){const t=g.folder({name:"Parent",id:e},this);t.addEventListener("click",async()=>{this.setFolder(e)}),this.grid.add(t)}this.parent=e}_setId(e){this.folderLoader.init(e),this.photoLoader.init(e)}}class x{constructor(){this.folderId=0,this.lastPage=null,this.currentPage=null}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async getFolder(){try{return(await d.request(`/api/folders/${this.folderId}`,"GET",null,this.folderId)).data}catch(e){console.error(e)}return null}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/subfolders?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}class S{constructor(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/photos?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
