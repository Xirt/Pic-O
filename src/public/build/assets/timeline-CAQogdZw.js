import{a as l,M as u,G as p}from"./Grid-FxjsC6xL.js";import{P as m}from"./PicoView-__B_6nHz.js";import{A as d}from"./AppRequest-B2BOAsCr.js";import{p as f}from"./domHelpers-BtKPVOZb.js";let h;document.addEventListener("DOMContentLoaded",async()=>{const c=new w;c.init();const e=document.getElementById("container");h=new m(e),t(h,c);function t(n,o){const s={"photo.more":r=>o.showMore(),"photo.info":r=>o.viewInfo(r.detail.id),"photo.download":r=>o.forceDownload(r.detail.id),"photo.shown":r=>o.recordView(r.detail.id)};for(const[r,a]of Object.entries(s))n.addEventListener(r,a)}});class w{constructor(e="container"){this.container=document.getElementById(e),this.currentDate=null,this.photoGroups={},this.currentGrid=null,this.grids=[],this.container=document.getElementById("container"),this.scrollSpy=new bootstrap.ScrollSpy(document.body,{target:"#dummy-nav"});const t=document.getElementById("currentSectionLabel");document.body.addEventListener("activate.bs.scrollspy",n=>{const o=document.querySelector("#dummy-nav a.active");o&&(t.textContent=o.textContent.trim())}),this.loader=new g,this.sleep=n=>new Promise(o=>setTimeout(o,n))}async init(){await this.showMore()}async showMore(){this.loader.hasNextPage()&&((await this.loader.next()).forEach(t=>{this.photoGroups[t.taken_date]||(this.photoGroups[t.taken_date]=[]),this.photoGroups[t.taken_date].push(t)}),this.addPhotoGroup())}addPhotoGroup(){const e=Object.entries(this.photoGroups);if(!e.length)return;const[t,n]=e[0];if(delete this.photoGroups[t],this.currentDate!=t){const o=`img_${n[0].id}`;this.createNavItem(o,n[0].taken_age),this.createGridSeparator(t),this.createGrid(o)}this.addPhotoGroupPhotos(this.currentGrid,n,e.length==1)}async addPhotoGroupPhotos(e,t,n){const o=t.map(async r=>{const a=await l.photo(r,!1);return a.querySelector(".btn-info").addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.viewInfo(r.id)}),a.querySelector(".btn-download").addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.forceDownload(r.id)}),a}),s=await Promise.all(o);for(const r of s)e.add(r,n)}createNavItem(e,t){const n=document.getElementById("dummy-nav"),o=document.createElement("a");o.textContent=t,o.href=`#${e}`,n.appendChild(o)}createGridSeparator(e){this.container.append(l.separator(e,this)),this.currentDate=e}createGrid(e=""){const t=document.createElement("div");t.dataset.cols="sm:3 lg:6",t.className="grid row w-100 g-0",this.container.appendChild(t),e&&(t.id=e),this.masonry=new u(t),this.currentGrid=new p(this,t),this.grids.push(this.currentGrid),t.addEventListener("grid.refresh",()=>{const n=this.grids.flatMap(o=>o.items);h.refresh(n)}),t.addEventListener("grid.complete",async()=>{this.scrollSpy.refresh(),this.addPhotoGroup()})}async recordView(e){try{const t=route("api.photos.impression",{photo:e});await d.request(t,"POST")}catch(t){console.error(t)}}async viewInfo(e){try{const o=route("api.photos.show",{photo:e}),s=await d.request(o,"GET");f(document.getElementById("infoForm"),{dimensions:`${s.data.width} x ${s.data.height}`,...s.data})}catch(o){console.error(o)}const t=document.getElementById("offcanvas-info");bootstrap.Offcanvas.getOrCreateInstance(t).show()}forceDownload(e){const t=route("photos.download",{photo:e});window.location.href=t}}class g{constructor(){this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(e=1){if(d.isLoading("photos"))return[];try{const t=await d.request(`/api/photos?page=${e}`,"GET",null,"photos");return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
