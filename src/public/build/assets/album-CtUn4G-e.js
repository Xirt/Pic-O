import{P as A}from"./PicoView-3alaDzrO.js";import{S as q,a as T}from"./SelectionManager-Dord-efE.js";import{g as S,A as l,p as g,o as y,t as v,r as E}from"./domHelpers-Da9rvIEx.js";import{G as k,a as D}from"./Grid-DsKHW_82.js";document.addEventListener("DOMContentLoaded",async()=>{const a=document.getElementById("grid"),t=document.getElementById("album").dataset.albumId;new q(a);const c=new x(t),d=new A(a);c.init(),P(d,c),I(a,d),new T({container:"addFolderFolder",apiUrl:route("api.folders.search")}),r("addFolderToAlbumForm","PUT",n=>route("api.albums.photos.addFromFolder",{album:n.album_id}),(n,e)=>route("albums.show",{album:e.album_id})),r("updateAlbumForm","PATCH",n=>route("api.albums.update",{album:t}),(n,e)=>window.location.href);function r(n,e="POST",u,o){const s=document.getElementById(n);s?.addEventListener("submit",async function(f){if(f.preventDefault(),!s.checkValidity())return s.reportValidity();s.querySelectorAll("button").forEach(m=>m.disabled=!0);try{const m=S(s),L=await l.request(u(m),e,m);s.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=o(L,m)},1e3)}catch(m){console.error(m)}}),s?.reset()}document.getElementById("offcanvasUpdateAlbum")?.addEventListener("show.bs.offcanvas",async function(n){try{const e=route("api.albums.show",{album:t}),u=await l.request(e,"GET");g(document.getElementById("updateAlbumForm"),u.data)}catch(e){console.error(e)}y("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum")?.addEventListener("show.bs.offcanvas",async function(n){try{const e=b.getAttribute("data-album-id"),u=await l.request(route("api.albums.tokens",{album:e}),"GET"),o=document.getElementById("tokenList");o.querySelectorAll(".token-wrapper").forEach(s=>s.remove()),u.data.forEach(s=>{o.appendChild(i(s))})}catch(e){console.error(e)}}),document.getElementById("multiDeleteBtn")?.addEventListener("click",async function(n){const e=document.querySelectorAll(".grid-item.selected");c.showRemovalconfirmation(e),n.preventDefault()});const b=document.getElementById("generateTokenBtn");b?.addEventListener("click",async function(n){n.preventDefault();try{const e=b.getAttribute("data-album-id"),u=await l.request(route("api.tokens.store"),"POST",{album_id:e});document.getElementById("tokenList").appendChild(i(u.data))}catch(e){console.error(e)}});function i(n){const e=route("albums.show",{album:n.album_id,token:n.token}),o=document.getElementById("tokenTpl").content.cloneNode(!0);o.querySelector("input").value=e,o.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),o.querySelector(".expires_at").value=n.expires_at,o.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e):(f.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),v("Copied to clipboard")});const f=o.querySelector(".btn-delete");return f.addEventListener("click",()=>{l.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),f.closest(".token-wrapper").remove(),v("Share link has been deleted")}),o}function P(n,e){const u={"photo.more":o=>e.showMore(),"photo.info":o=>e.viewInfo(o.detail.id),"photo.cover":o=>e.setCover(o.detail.id),"photo.download":o=>e.forceDownload(o.detail.id),"photo.remove":o=>{e.remove(o.detail.id),n.next()},"photo.shown":o=>e.recordView(o.detail.id)};for(const[o,s]of Object.entries(u))n.addEventListener(o,s)}function I(n,e){Object.entries({"grid.refresh":o=>e.refresh(o.detail),"selection.start":o=>e.disable(),"selection.stop":o=>e.enable()}).forEach(([o,s])=>{n.addEventListener(o,s)})}});class x{constructor(a){this.id=a,this.grid=new k(this),this.loader=new C(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const t=(await this.loader.next()).map(async d=>{const r=await D.photo(d);return r.querySelector(".btn-delete")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.remove(d.id)}),r.querySelector(".btn-info")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.viewInfo(d.id)}),r.querySelector(".btn-cover")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.setCover(d.id)}),r.querySelector(".btn-download")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.forceDownload(d.id)}),r}),c=await Promise.all(t);this.grid.add(c)}}async recordView(a){try{const t=route("api.photos.impression",{photo:a});await l.request(t,"POST")}catch(t){console.error(t)}}async viewInfo(a){try{const t=route("api.photos.show",{photo:a}),c=await l.request(t,"GET");g(document.getElementById("infoForm"),{dimensions:`${c.data.width} x ${c.data.height}`,...c.data})}catch(t){console.error(t)}y("offcanvas-info")}forceDownload(a){const t=route("photos.download",{photo:a});window.location.href=t}async setCover(a){try{const t=route("api.albums.update",{album:this.id});await l.request(t,"PATCH",{photo_id:a}),v("Album cover set")}catch(t){console.error(t)}}async remove(a){const t=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await l.request(r,"DELETE")}catch(r){console.error(r)}const c=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(t),c.show();const d=document.getElementById("btn-undo");E(d).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await l.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(t),c.hide()})}showRemovalconfirmation(a){const t=Array.isArray(a)?a:a instanceof NodeList?Array.from(a):[a],c=document.getElementById("delCount");c.textContent=t.length;const d=y("offcanvasRemovePhotos");let r=document.getElementById("btn-remove");E(r).addEventListener("click",()=>{try{const h=route("api.albums.photos.removeMultiple",{album:this.id});l.request(h,"DELETE",{pictures:t.map(p=>p.getAttribute("data-id"))});for(const p of t)this.grid.remove(p);v("Photo(s) removed")}catch(h){console.log(h)}d.hide()})}}class C{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||l.isLoading(this.albumId))return[];try{const t=await l.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
