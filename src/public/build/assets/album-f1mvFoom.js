import{P as b}from"./PicoView-C1nBVlJD.js";import{S as g}from"./Selection-BoYlDC7p.js";import{A as i}from"./AppRequest-B2BOAsCr.js";import{G as y,a as E}from"./Grid-DHBf-eNL.js";import{t as m,p as P,o as B,r as I}from"./domHelpers-nYN5pVaO.js";document.addEventListener("DOMContentLoaded",async()=>{const u=document.getElementById("grid"),n=document.getElementById("album").dataset.albumId;new g(u);const o=new L(n),s=new b(u);o.init(),f(s,o),v(u,s),document.getElementById("offcanvas-share-album").addEventListener("show.bs.offcanvas",async function(r){try{const t=a.getAttribute("data-album-id"),d=await i.request(route("api.albums.tokens",{album:t}),"GET"),e=document.getElementById("tokenList");d.data.forEach(l=>{e.appendChild(h(l))})}catch(t){console.error(t)}});const a=document.getElementById("generateTokenBtn");a.addEventListener("click",async function(r){r.preventDefault();try{const t=a.getAttribute("data-album-id"),d=await i.request(route("api.tokens.store"),"POST",{album_id:t});document.getElementById("tokenList").appendChild(h(d.data)),console.log(d)}catch(t){console.error(t)}});function h(r){const t=route("albums.show",{album:r.album_id,token:r.token}),e=document.getElementById("tokenTpl").content.cloneNode(!0);e.querySelector("input").value=t,e.querySelector(".expiry").classList.toggle("d-none",!r.expires_at),e.querySelector(".expires_at").value=r.expires_at,e.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t):(p.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),m("Copied to clipboard")});const p=e.querySelector(".btn-delete");return p.addEventListener("click",()=>{i.request(route("api.tokens.destroy",{token:r.id}),"DELETE"),p.closest(".token-wrapper").remove(),m("Share link has been deleted")}),e}function f(r,t){const d={"photo.more":e=>t.showMore(),"photo.info":e=>t.viewInfo(e.detail.id),"photo.cover":e=>t.setCover(e.detail.id),"photo.download":e=>t.forceDownload(e.detail.id),"photo.remove":e=>{t.remove(e.detail.id),r.next()}};for(const[e,l]of Object.entries(d))r.addEventListener(e,l)}function v(r,t){Object.entries({"grid.refresh":e=>t.refresh(e.detail),"selection.start":e=>t.disable(),"selection.stop":e=>t.enable()}).forEach(([e,l])=>{r.addEventListener(e,l)})}});class L{constructor(n){this.id=n,this.grid=new y(this),this.loader=new q(n)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const o=(await this.loader.next()).map(async c=>{const a=await E.photo(c);return a.querySelector(".btn-delete").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.remove(c.id)}),a.querySelector(".btn-info").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.viewInfo(c.id)}),a.querySelector(".btn-cover").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.setCover(c.id)}),a.querySelector(".btn-download").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.forceDownload(c.id)}),a}),s=await Promise.all(o);this.grid.add(s)}}async viewInfo(n){try{const o=route("api.photos.show",{photo:n}),s=await i.request(o,"GET");P(document.getElementById("infoForm"),{dimensions:`${s.data.width} x ${s.data.height}`,...s.data})}catch(o){console.error(o)}B("offcanvas-info")}forceDownload(n){const o=route("photos.download",{photo:n});window.location.href=o}async setCover(n){try{const o=route("api.albums.update",{album:this.id});await i.request(o,"PATCH",{photo_id:n}),m("Album cover set")}catch(o){console.error(o)}}async remove(n){const o=document.getElementById(`card-${n}`);try{const a=route("api.albums.photos.removeOne",{album:this.id,photo:n});await i.request(a,"DELETE")}catch(a){console.error(a)}const s=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(o),s.show();const c=document.getElementById("btn-undo");I(c).addEventListener("click",async()=>{try{const a=route("api.albums.photos.addOne",{album:this.id,photo:n});await i.request(a,"PUT")}catch(a){console.error(a)}this.grid.add(o),s.hide()})}}class q{constructor(n){this.albumId=n,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(n=1){if(this.albumId==null||i.isLoading(this.albumId))return[];try{const o=await i.request(`/api/albums/${this.albumId}/photos?page=${n}`,"GET",null,this.albumId);return this.currentPage=o.meta.current_page,this.lastPage=o.meta.last_page,o.data}catch(o){console.error(o)}return[]}}
