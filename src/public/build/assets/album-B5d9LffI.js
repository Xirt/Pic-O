import{P as B}from"./PicoView-DySAx8w5.js";import{S as P}from"./Selection-BoYlDC7p.js";import{A as c}from"./AppRequest-B2BOAsCr.js";import{G as I,a as L}from"./Grid-Da51xS1C.js";import{g as q,p as w,o as y,t as b,r as k}from"./domHelpers-tPkAV0wh.js";document.addEventListener("DOMContentLoaded",async()=>{const m=document.getElementById("grid"),a=document.getElementById("album").dataset.albumId;new P(m);const e=new T(a),i=new B(m);e.init(),v(i,e),s(m,i);const d=document.getElementById("updateAlbumForm");d.addEventListener("submit",async function(n){n.preventDefault();try{await c.request(route("api.albums.update",{album:a}),"PATCH",q(d),"albums"),location.reload()}catch(o){console.error(o)}}),document.getElementById("offcanvasUpdateAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const o=route("api.albums.show",{album:a}),l=await c.request(o,"GET");w(document.getElementById("updateAlbumForm"),l.data)}catch(o){console.error(o)}y("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const o=p.getAttribute("data-album-id"),l=await c.request(route("api.albums.tokens",{album:o}),"GET"),t=document.getElementById("tokenList");l.data.forEach(u=>{t.appendChild(h(u))})}catch(o){console.error(o)}});const p=document.getElementById("generateTokenBtn");p.addEventListener("click",async function(n){n.preventDefault();try{const o=p.getAttribute("data-album-id"),l=await c.request(route("api.tokens.store"),"POST",{album_id:o});document.getElementById("tokenList").appendChild(h(l.data)),console.log(l)}catch(o){console.error(o)}});function h(n){const o=route("albums.show",{album:n.album_id,token:n.token}),t=document.getElementById("tokenTpl").content.cloneNode(!0);t.querySelector("input").value=o,t.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),t.querySelector(".expires_at").value=n.expires_at,t.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(o):(f.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),b("Copied to clipboard")});const f=t.querySelector(".btn-delete");return f.addEventListener("click",()=>{c.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),f.closest(".token-wrapper").remove(),b("Share link has been deleted")}),t}function v(n,o){const l={"photo.more":t=>o.showMore(),"photo.info":t=>o.viewInfo(t.detail.id),"photo.cover":t=>o.setCover(t.detail.id),"photo.download":t=>o.forceDownload(t.detail.id),"photo.remove":t=>{o.remove(t.detail.id),n.next()},"photo.shown":t=>o.recordView(t.detail.id)};for(const[t,u]of Object.entries(l))n.addEventListener(t,u)}function s(n,o){Object.entries({"grid.refresh":t=>o.refresh(t.detail),"selection.start":t=>o.disable(),"selection.stop":t=>o.enable()}).forEach(([t,u])=>{n.addEventListener(t,u)})}});class T{constructor(a){this.id=a,this.grid=new I(this),this.loader=new A(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const e=(await this.loader.next()).map(async d=>{const r=await L.photo(d);return r.querySelector(".btn-delete").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.remove(d.id)}),r.querySelector(".btn-info").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.viewInfo(d.id)}),r.querySelector(".btn-cover").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.setCover(d.id)}),r.querySelector(".btn-download").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.forceDownload(d.id)}),r}),i=await Promise.all(e);this.grid.add(i)}}async recordView(a){try{const e=route("api.photos.impression",{photo:a});await c.request(e,"POST")}catch(e){console.error(e)}}async viewInfo(a){try{const e=route("api.photos.show",{photo:a}),i=await c.request(e,"GET");w(document.getElementById("infoForm"),{dimensions:`${i.data.width} x ${i.data.height}`,...i.data})}catch(e){console.error(e)}y("offcanvas-info")}forceDownload(a){const e=route("photos.download",{photo:a});window.location.href=e}async setCover(a){try{const e=route("api.albums.update",{album:this.id});await c.request(e,"PATCH",{photo_id:a}),b("Album cover set")}catch(e){console.error(e)}}async remove(a){const e=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await c.request(r,"DELETE")}catch(r){console.error(r)}const i=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(e),i.show();const d=document.getElementById("btn-undo");k(d).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await c.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(e),i.hide()})}}class A{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||c.isLoading(this.albumId))return[];try{const e=await c.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=e.meta.current_page,this.lastPage=e.meta.last_page,e.data}catch(e){console.error(e)}return[]}}
