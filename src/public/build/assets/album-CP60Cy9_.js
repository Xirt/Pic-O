import{P as p}from"./PicoView-iUxXwDXZ.js";import{S as f}from"./Selection-DBGP1SeL.js";import{A as c}from"./AppRequest-BdPYhK6t.js";import{G as v,a as g}from"./Grid-7GupHutO.js";import{p as w,o as b,t as m,r as E}from"./domHelpers-0caSGQTr.js";document.addEventListener("DOMContentLoaded",async()=>{const d=document.getElementById("grid"),o=document.getElementById("album").dataset.albumId;new f(d);const e=new P(o),s=new p(d);e.init(),a(s,e),h(d,s);const r=document.getElementById("generateTokenBtn");r.addEventListener("click",async function(i){i.preventDefault();try{const n=r.getAttribute("data-album-id"),l=await c.request(route("api.tokens.store"),"POST",{album_id:n});console.log(l)}catch(n){console.error(n)}closeCanvas("offcanvas-share-album"),shareForm.reset()});function a(i,n){const l={"photo.more":t=>n.showMore(),"photo.info":t=>n.viewInfo(t.detail.id),"photo.cover":t=>n.setCover(t.detail.id),"photo.download":t=>n.forceDownload(t.detail.id),"photo.remove":t=>{n.remove(t.detail.id),i.next()}};for(const[t,u]of Object.entries(l))i.addEventListener(t,u)}function h(i,n){Object.entries({"grid.refresh":t=>n.refresh(),"selection.start":t=>n.disable(),"selection.stop":t=>n.enable()}).forEach(([t,u])=>{i.addEventListener(t,u)})}});class P{constructor(o){this.id=o,this.grid=new v(this),this.loader=new y(o)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const e=(await this.loader.next()).map(async r=>{const a=await g.photo(r);return a.querySelector(".btn-delete").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.remove(r.id)}),a.querySelector(".btn-info").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.viewInfo(r.id)}),a.querySelector(".btn-cover").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.setCover(r.id)}),a.querySelector(".btn-download").addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.forceDownload(r.id)}),a}),s=await Promise.all(e);this.grid.add(s)}}async viewInfo(o){try{const e=route("api.photos.show",{photo:o}),s=await c.request(e,"GET");w(document.getElementById("infoForm"),{dimensions:`${s.data.width} x ${s.data.height}`,...s.data})}catch(e){console.error(e)}b("offcanvas-info")}forceDownload(o){const e=route("photos.download",{photo:o});window.location.href=e}async setCover(o){try{const e=route("api.albums.update",{album:this.id});await c.request(e,"PATCH",{photo_id:o}),m("coverToast")}catch(e){console.error(e)}}async remove(o){const e=document.getElementById(`card-${o}`);try{const a=route("api.albums.photos.removeOne",{album:this.id,photo:o});await c.request(a,"DELETE")}catch(a){console.error(a)}const s=m("removalToast");this.grid.remove(e);const r=document.getElementById("btn-undo");E(r).addEventListener("click",async()=>{try{const a=route("api.albums.photos.addOne",{album:this.id,photo:o});await c.request(a,"PUT")}catch(a){console.error(a)}this.grid.add(e),s.hide()})}}class y{constructor(o){this.albumId=o,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(o=1){if(this.albumId==null||c.isLoading(this.albumId))return[];try{const e=await c.request(`/api/albums/${this.albumId}/photos?page=${o}`,"GET",null,this.albumId);return this.currentPage=e.meta.current_page,this.lastPage=e.meta.last_page,e.data}catch(e){console.error(e)}return[]}}
