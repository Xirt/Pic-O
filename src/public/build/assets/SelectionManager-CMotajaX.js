import{e as v,A as E}from"./domHelpers-Bl1jAPjX.js";const a=(()=>{let n,t=0,e={onEnter:null,onExit:null};function i(c=".toolbar",{onEnter:u=null,onExit:l=null}={}){let d,p;n=document.querySelector(c),e.onEnter=u,e.onExit=l,(d=n.querySelector(".select-start"))&&d.addEventListener("click",h=>{h.preventDefault(),s(0),typeof e.onEnter=="function"&&e.onEnter()}),(p=n.querySelector(".select-stop"))&&p.addEventListener("click",h=>{h.preventDefault(),o(),typeof e.onExit=="function"&&e.onExit()}),r()}function s(c=0){t=c,n.classList.add("selection-mode"),r()}function o(){t=0,n.classList.remove("selection-mode"),r()}function m(c){t=c,r()}function r(){n.querySelectorAll(".select-action-single").forEach(l=>{l.disabled=t!=1}),n.querySelectorAll(".select-action").forEach(l=>{l.disabled=t<=0})}return{init:i,show:s,hide:o,update:m}})();class L{constructor(t,e){this.container=t,this.active=!1,this.selection=new Set,this.setupSelectionListener(),this.setupToolbar()}setupToolbar(){a.init(".toolbar",{onEnter:()=>{this.enterSelectionMode()},onExit:()=>{this.cancelSelection()}})}setupSelectionListener(){let t=null;this.container.addEventListener("mousedown",e=>{t=setTimeout(()=>{const i=e.target.closest(".selectable");i&&this.container.contains(i)&&this.enterSelectionMode()},400),e.preventDefault()}),this.container.addEventListener("mouseup",e=>{if(clearTimeout(t),!this.active)return;const i=e.target.closest(".selectable");if(!i||!this.container.contains(i))return;const s=i.dataset.id;this.selection.has(s)?(this.selection.delete(s),i.classList.remove("selected")):(this.selection.add(s),i.classList.add("selected")),a.update(this.selection.size),e.stopPropagation(),e.preventDefault()}),this.container.addEventListener("click",e=>{this.active&&(e.stopPropagation(),e.preventDefault())}),this.container.addEventListener("mouseleave",()=>clearTimeout(t))}enterSelectionMode(){this.active=!0,this.container.parentElement.classList.add("selection-mode"),a.show(this.getCount()),this.container.dispatchEvent(new CustomEvent("selection.start",{}))}cancelSelection(){this.active&&(this.active=!1,this.selection.clear(),this.container.parentElement.classList.remove("selection-mode"),this.container.querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),a.hide()),this.container.dispatchEvent(new CustomEvent("selection.stop",{}))}getSelectedIds(){return Array.from(this.selection)}getCount(){return this.selection.size}}class y{constructor({container:t,apiUrl:e}){this.container=document.getElementById(t),this.menu=this.container.querySelector(".search-select-wrapper"),this.selectList=this.container.querySelector(".search-select-list"),this.selectEl=this.container.querySelector("input[readonly]"),this.hiddenEl=this.container.querySelector('input[type="hidden"]'),this.inputEl=this.menu.querySelector('input[type="text"]'),this.optionTpl=this.container.dataset.tplOption,this.noOptionTpl=this.container.dataset.tplEmpty,this.searchEndpoint=e,this.currentItems=[],this.lastQuery=null,this.debounceTimer=null,this.activeIndex=-1,this.init()}init(){this.inputEl.addEventListener("input",()=>{this.updateList(),this.show()}),this.inputEl.addEventListener("keydown",t=>{this.handleKeyDown(t)}),this.selectEl.addEventListener("focus",()=>{this.inputEl.focus(),this.updateList(),this.show()}),v(this.selectEl),this.selectEl.addEventListener("visible",()=>{this.updateList()}),document.addEventListener("click",t=>{this.container.contains(t.target)||this.hide()})}getOptionFragment(t){const i=document.getElementById(this.optionTpl).content.cloneNode(!0);return i.querySelectorAll("[data-field]").forEach(s=>{const o=s.dataset.field;o in t&&(s.textContent=t[o])}),i}getNoOptionFragment(){return document.getElementById(this.noOptionTpl).content.cloneNode(!0)}populateOptionList(t=[]){if(this.clear(),!t||t.length===0){const e=this.getNoOptionFragment();this.selectList.appendChild(e);return}t.forEach((e,i)=>{const s=this.getOptionFragment(e);s.querySelector("a").addEventListener("click",o=>{this.selectItem(i),o.preventDefault()}),this.selectList.appendChild(s),e.id==this.hiddenEl.value&&this.updateActiveItem(i)}),this.currentItems=t}setItem(t,e){this.inputEl.value=e,this.selectEl.value=e,this.hiddenEl.value=t,this.updateList()}selectItem(t){this.currentItems[t]&&(this.updateActiveItem(t),setTimeout(()=>this.updateList(),500),this.hide(),this.inputEl.value=this.currentItems[t].name,this.selectEl.value=this.currentItems[t].name,this.hiddenEl.value=this.currentItems[t].id)}async fetchItems(t){try{const e=await E.request(`${this.searchEndpoint}?q=${encodeURIComponent(t)}`,"GET");this.populateOptionList(e.data)}catch(e){console.error(e)}}updateActiveItem(t){const e=Array.from(this.selectList.children).filter(i=>!i.classList.contains("disabled"));e.length!==0&&(e.forEach(i=>i.classList.remove("active")),e[t].classList.add("active"),this.activeIndex=t)}handleKeyDown(t){const e=this.selectList.children.length;if(e!==0)switch(t.key){case"ArrowDown":t.preventDefault(),this.updateActiveItem((this.activeIndex+1)%e),this.show();break;case"ArrowUp":t.preventDefault(),this.updateActiveItem((this.activeIndex-1+e)%e),this.show();break;case"Enter":t.preventDefault(),this.activeIndex>=0&&this.selectItem(this.activeIndex);break;case"Escape":this.hide();break}}updateList(){const t=this.inputEl.value.trim();t!==this.lastQuery&&(this.lastQuery=t,clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.fetchItems(t)},300))}clear(){this.selectList.innerHTML="",this.currentItems=[],this.activeIndex=-1}show(){this.menu.classList.add("grow")}hide(){this.menu.classList.remove("grow")}}export{L as S,y as a};
