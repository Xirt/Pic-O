import{e as r,A as h}from"./domHelpers-kP-iqNJa.js";class l{constructor({container:t,apiUrl:e}){this.container=document.getElementById(t),this.menu=this.container.querySelector(".search-select-wrapper"),this.selectList=this.container.querySelector(".search-select-list"),this.selectEl=this.container.querySelector("input[readonly]"),this.hiddenEl=this.container.querySelector('input[type="hidden"]'),this.inputEl=this.menu.querySelector('input[type="text"]'),this.optionTpl=this.container.dataset.tplOption,this.noOptionTpl=this.container.dataset.tplEmpty,this.searchEndpoint=e,this.currentItems=[],this.lastQuery=null,this.debounceTimer=null,this.activeIndex=-1,this.init()}init(){this.inputEl.addEventListener("input",()=>{this.updateList(),this.show()}),this.inputEl.addEventListener("keydown",t=>{this.handleKeyDown(t)}),this.selectEl.addEventListener("focus",()=>{this.inputEl.focus(),this.updateList(),this.show()}),r(this.selectEl),this.selectEl.addEventListener("visible",()=>{this.updateList()}),document.addEventListener("click",t=>{this.container.contains(t.target)||this.hide()})}getOptionFragment(t){const i=document.getElementById(this.optionTpl).content.cloneNode(!0);return i.querySelectorAll("[data-field]").forEach(s=>{const n=s.dataset.field;n in t&&(s.textContent=t[n])}),i}getNoOptionFragment(){return document.getElementById(this.noOptionTpl).content.cloneNode(!0)}populateOptionList(t=[]){if(this.clear(),!t||t.length===0){const e=this.getNoOptionFragment();this.selectList.appendChild(e);return}t.forEach((e,i)=>{const s=this.getOptionFragment(e);s.querySelector("a").addEventListener("click",n=>{this.selectItem(i),n.preventDefault()}),this.selectList.appendChild(s),e.id==this.hiddenEl.value&&this.updateActiveItem(i)}),this.currentItems=t}setItem(t,e){this.inputEl.value=e,this.selectEl.value=e,this.hiddenEl.value=t,this.updateList()}selectItem(t){this.currentItems[t]&&(this.updateActiveItem(t),setTimeout(()=>this.updateList(),500),this.hide(),this.inputEl.value=this.currentItems[t].name,this.selectEl.value=this.currentItems[t].name,this.hiddenEl.value=this.currentItems[t].id)}async fetchItems(t,e=!0){try{const i=await h.request(`${this.searchEndpoint}?q=${encodeURIComponent(t)}`,"GET");this.populateOptionList(i.data)}catch(i){console.error(i)}}updateActiveItem(t){const e=Array.from(this.selectList.children).filter(i=>!i.classList.contains("disabled"));e.length!==0&&(e.forEach(i=>i.classList.remove("active")),e[t].classList.add("active"),this.activeIndex=t)}handleKeyDown(t){const e=this.selectList.children.length;if(e!==0)switch(t.key){case"ArrowDown":t.preventDefault(),this.updateActiveItem((this.activeIndex+1)%e),this.show();break;case"ArrowUp":t.preventDefault(),this.updateActiveItem((this.activeIndex-1+e)%e),this.show();break;case"Enter":t.preventDefault(),this.activeIndex>=0&&this.selectItem(this.activeIndex);break;case"Escape":this.hide();break}}updateList(){const t=this.inputEl.value.trim();t!==this.lastQuery&&(this.lastQuery=t,clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.fetchItems(t)},300))}clear(){this.selectList.innerHTML="",this.currentItems=[],this.activeIndex=-1}show(){this.menu.classList.add("grow")}hide(){this.menu.classList.remove("grow")}}export{l as S};
