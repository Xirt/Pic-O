import{P as I}from"./PicoView-DySAx8w5.js";import{S as L}from"./Selection-BoYlDC7p.js";import{A as c}from"./AppRequest-B2BOAsCr.js";import{G as q,a as k}from"./Grid-Da51xS1C.js";import{g as T,p as w,o as y,t as v,r as A}from"./domHelpers-tPkAV0wh.js";document.addEventListener("DOMContentLoaded",async()=>{const p=document.getElementById("grid"),a=document.getElementById("album").dataset.albumId;new L(p);const o=new S(a),l=new I(p);o.init(),s(l,o),B(p,l);const d=document.getElementById("updateAlbumForm");d.addEventListener("submit",async function(n){n.preventDefault();try{await c.request(route("api.albums.update",{album:a}),"PATCH",T(d),"albums"),location.reload()}catch(t){console.error(t)}}),document.getElementById("offcanvasUpdateAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=route("api.albums.show",{album:a}),u=await c.request(t,"GET");w(document.getElementById("updateAlbumForm"),u.data)}catch(t){console.error(t)}y("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=h.getAttribute("data-album-id"),u=await c.request(route("api.albums.tokens",{album:t}),"GET"),e=document.getElementById("tokenList");u.data.forEach(m=>{e.appendChild(f(m))})}catch(t){console.error(t)}}),document.getElementById("multiDeleteBtn").addEventListener("click",async function(n){n.preventDefault();try{alert("Pending implementation")}catch(t){console.error(t)}}),i;const h=document.getElementById("generateTokenBtn");h.addEventListener("click",async function(n){n.preventDefault();try{const t=h.getAttribute("data-album-id"),u=await c.request(route("api.tokens.store"),"POST",{album_id:t});document.getElementById("tokenList").appendChild(f(u.data))}catch(t){console.error(t)}});function f(n){const t=route("albums.show",{album:n.album_id,token:n.token}),e=document.getElementById("tokenTpl").content.cloneNode(!0);e.querySelector("input").value=t,e.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),e.querySelector(".expires_at").value=n.expires_at,e.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t):(b.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),v("Copied to clipboard")});const b=e.querySelector(".btn-delete");return b.addEventListener("click",()=>{c.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),b.closest(".token-wrapper").remove(),v("Share link has been deleted")}),e}function s(n,t){const u={"photo.more":e=>t.showMore(),"photo.info":e=>t.viewInfo(e.detail.id),"photo.cover":e=>t.setCover(e.detail.id),"photo.download":e=>t.forceDownload(e.detail.id),"photo.remove":e=>{t.remove(e.detail.id),n.next()},"photo.shown":e=>t.recordView(e.detail.id)};for(const[e,m]of Object.entries(u))n.addEventListener(e,m)}function B(n,t){Object.entries({"grid.refresh":e=>t.refresh(e.detail),"selection.start":e=>t.disable(),"selection.stop":e=>t.enable()}).forEach(([e,m])=>{n.addEventListener(e,m)})}});class S{constructor(a){this.id=a,this.grid=new q(this),this.loader=new D(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const o=(await this.loader.next()).map(async d=>{const r=await k.photo(d);return r.querySelector(".btn-delete").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.remove(d.id)}),r.querySelector(".btn-info").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.viewInfo(d.id)}),r.querySelector(".btn-cover").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.setCover(d.id)}),r.querySelector(".btn-download").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.forceDownload(d.id)}),r}),l=await Promise.all(o);this.grid.add(l)}}async recordView(a){try{const o=route("api.photos.impression",{photo:a});await c.request(o,"POST")}catch(o){console.error(o)}}async viewInfo(a){try{const o=route("api.photos.show",{photo:a}),l=await c.request(o,"GET");w(document.getElementById("infoForm"),{dimensions:`${l.data.width} x ${l.data.height}`,...l.data})}catch(o){console.error(o)}y("offcanvas-info")}forceDownload(a){const o=route("photos.download",{photo:a});window.location.href=o}async setCover(a){try{const o=route("api.albums.update",{album:this.id});await c.request(o,"PATCH",{photo_id:a}),v("Album cover set")}catch(o){console.error(o)}}async remove(a){const o=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await c.request(r,"DELETE")}catch(r){console.error(r)}const l=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(o),l.show();const d=document.getElementById("btn-undo");A(d).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await c.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(o),l.hide()})}}class D{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||c.isLoading(this.albumId))return[];try{const o=await c.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=o.meta.current_page,this.lastPage=o.meta.last_page,o.data}catch(o){console.error(o)}return[]}}
