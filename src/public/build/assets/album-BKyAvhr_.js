import{P as m}from"./PicoView-iUxXwDXZ.js";import{S as p}from"./Selection-DBGP1SeL.js";import{A as c}from"./AppRequest-BdPYhK6t.js";import{G as f,a as v}from"./Grid-BF5OeTv2.js";import{p as w,o as g,t as h,r as E}from"./domHelpers-0caSGQTr.js";document.addEventListener("DOMContentLoaded",async()=>{const d=document.getElementById("grid"),e=document.getElementById("album").dataset.albumId;new p(d);const t=new P(e),s=new m(d);t.init(),i(s,t),a(d,s);function i(l,r){const u={"photo.more":o=>r.showMore(),"photo.info":o=>r.viewInfo(o.detail.id),"photo.cover":o=>r.setCover(o.detail.id),"photo.download":o=>r.forceDownload(o.detail.id),"photo.remove":o=>{r.remove(o.detail.id),l.next()}};for(const[o,n]of Object.entries(u))l.addEventListener(o,n)}function a(l,r){Object.entries({"grid.refresh":o=>r.refresh(),"selection.start":o=>r.disable(),"selection.stop":o=>r.enable()}).forEach(([o,n])=>{l.addEventListener(o,n)})}});class P{constructor(e){this.id=e,this.grid=new f(this),this.loader=new b(e)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const t=(await this.loader.next()).map(async i=>{const a=await v.photo(i);return a.querySelector(".btn-delete").addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.remove(i.id)}),a.querySelector(".btn-info").addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.viewInfo(i.id)}),a.querySelector(".btn-cover").addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.setCover(i.id)}),a.querySelector(".btn-download").addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.forceDownload(i.id)}),a}),s=await Promise.all(t);this.grid.add(s)}}async viewInfo(e){try{const t=route("api.photos.show",{photo:e}),s=await c.request(t,"GET");w(document.getElementById("infoForm"),{dimensions:`${s.data.width} x ${s.data.height}`,...s.data})}catch(t){console.error(t)}g("offcanvas-info")}forceDownload(e){const t=route("photos.download",{photo:e});window.location.href=t}async setCover(e){try{const t=route("api.albums.update",{album:this.id});await c.request(t,"PATCH",{photo_id:e}),h("coverToast")}catch(t){console.error(t)}}async remove(e){const t=document.getElementById(`card-${e}`);try{const a=route("api.albums.photos.removeOne",{album:this.id,photo:e});await c.request(a,"DELETE")}catch(a){console.error(a)}const s=h("removalToast");this.grid.remove(t);const i=document.getElementById("btn-undo");E(i).addEventListener("click",async()=>{try{const a=route("api.albums.photos.addOne",{album:this.id,photo:e});await c.request(a,"PUT")}catch(a){console.error(a)}this.grid.add(t),s.hide()})}}class b{constructor(e){this.albumId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(e=1){if(this.albumId==null||c.isLoading(this.albumId))return[];try{const t=await c.request(`/api/albums/${this.albumId}/photos?page=${e}`,"GET",null,this.albumId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
