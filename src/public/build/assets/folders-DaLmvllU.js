import{P as y}from"./PicoView-B5R2qF6H.js";import{S as I}from"./Selection-BoYlDC7p.js";import{g as F,A as d,p as v,o as L}from"./domHelpers-kP-iqNJa.js";import{G as _,a as P}from"./Grid-CbBVb41u.js";import{S as w}from"./SelectionManager-B1gnBdxg.js";let E;document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("grid"),t=new T(new I(e)),n=new y(e);t.init(),c(n,t),h(e,n),new w({container:"addFolderAlbum",apiUrl:route("api.albums.search")}),m("addFolderToAlbumForm","PUT",a=>route("api.albums.photos.addFromFolder",{album:a.album_id}),(a,s)=>route("albums.show",{album:s.album_id})),b("offcanvas-add-selection-to-album"),new w({container:"addSelectionAlbum",apiUrl:route("api.albums.search")}),m("addSelectionToAlbumForm","PUT",a=>route("api.albums.photos.addMultiple",{album:a.album_id}),(a,s)=>route("albums.show",{album:s.album_id})),E=new w({container:"createAlbumFromFolder",apiUrl:route("api.folders.search")}),m("createAlbumFromFolderForm","POST",a=>route("api.albums.storeFromFolder"),a=>route("albums.show",{album:a.data.id})),b("offcanvas-create-album-from-selection"),m("createAlbumFromSelectionForm","POST",a=>route("api.albums.store"),a=>route("albums.show",{album:a.data.id}));function c(a,s){const i={"photo.more":o=>s.showMore(),"photo.info":o=>s.viewInfo(o.detail.id),"photo.download":o=>s.forceDownload(o.detail.id)};for(const[o,r]of Object.entries(i))a.addEventListener(o,r)}function h(a,s){Object.entries({"grid.refresh":o=>s.refresh(o.detail),"selection.start":o=>s.disable(),"selection.stop":o=>s.enable()}).forEach(([o,r])=>{a.addEventListener(o,r)})}function b(a,s=".container-hidden"){const i=document.getElementById(a);i.addEventListener("show.bs.offcanvas",()=>{const o=e.querySelectorAll(".selected"),r=Array.from(o).map(u=>u.dataset.id),f=i.querySelector(s);f.innerHTML="",r.forEach(u=>{const g=document.createElement("input");g.name="pictures",g.type="hidden",g.value=u,f.appendChild(g)});const l=i.querySelector(".picture-count");l.textContent=r.length})}function m(a,s="POST",i,o){const r=document.getElementById(a);r.addEventListener("submit",async function(f){if(f.preventDefault(),!r.checkValidity())return r.reportValidity();try{const l=F(r),u=await d.request(i(l),s,l,"albums");r.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=o(u,l)},1e3)}catch(l){console.error(l)}}),r.reset()}});class T{constructor(e){this.selector=e,this.grid=new _(this),this.folderLoader=new S,this.photoLoader=new x}async init(){this.loading=!1;const e=await this.folderLoader.getFolder();this._setParent(e.parent_id),this._setName(e.name),this._setId(e.id),await this.showMore()}isLoading(){return this.loading}async showMore(){if(this.loading=!0,this.folderLoader.hasNextPage()){const t=(await this.folderLoader.next()).map(c=>{const h=P.folder(c,this);return h.addEventListener("click",async()=>{this.setFolder(c.id)}),h}),n=await Promise.all(t);this.grid.add(n)}if(!this.folderLoader.hasNextPage()){const t=(await this.photoLoader.next()).map(c=>P.photoFolder(c,this)),n=await Promise.all(t);this.grid.add(n)}this.loading=!1}async viewInfo(e){try{const t=route("api.photos.show",{photo:e}),n=await d.request(t,"GET");v(document.getElementById("infoForm"),{dimensions:`${n.data.width} x ${n.data.height}`,...n.data})}catch(t){console.error(t)}L("offcanvas-info")}forceDownload(e){const t=route("photos.download",{photo:e});window.location.href=t}async setFolder(e){this.selector.cancelSelection(),this.grid.clear(),this._setId(e),this.init()}_setName(e){document.getElementById("title").innerHTML=e}_setParent(e){if(e!=null){const t=P.folder({name:"Parent",id:e},this);t.addEventListener("click",async()=>{this.setFolder(e)}),this.grid.add(t)}this.parent=e}_setId(e){this.folderLoader.init(e),this.photoLoader.init(e)}}class S{constructor(){this.folderEl=document.getElementById("folderId"),this.folderId=0,this.lastPage=null,this.currentPage=null}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0,this.folderEl.value=e}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async getFolder(){try{const e=await d.request(`/api/folders/${this.folderId}`,"GET",null,this.folderId);return E.setItem(e.data.id,e.data.name),e.data}catch(e){console.error(e)}return null}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/subfolders?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}class x{constructor(e){this.countEl=document.getElementById("photoCount"),this.folderId=e,this.lastPage=null,this.currentPage=0}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/photos?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,this.updatePhotoCount(t.meta.total),t.data}catch(t){console.error(t)}return[]}updatePhotoCount(e=0){this.countEl.innerHTML=e}}
