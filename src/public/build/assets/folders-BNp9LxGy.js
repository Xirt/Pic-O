import{P as E}from"./PicoView-__B_6nHz.js";import{S as I}from"./Selection-BoYlDC7p.js";import{A as d}from"./AppRequest-B2BOAsCr.js";import{G as L,a as p}from"./Grid-FxjsC6xL.js";import{S as v}from"./SelectionManager-BbtZTF85.js";import{g as b,p as _,o as F}from"./domHelpers-BtKPVOZb.js";document.addEventListener("DOMContentLoaded",async()=>{const t=document.getElementById("grid"),e=new S(new I(t)),n=new E(t);new v({container:"folderSearchSelect",apiUrl:route("api.albums.search")}).updateList(),e.init(),u(n,e),y(t,n),P("offcanvas-create-album"),P("offcanvas-update-album"),w("createAlbumForm","POST",a=>route("api.albums.store"),a=>route("albums.show",{album:a.data.id})),w("updateAlbumForm","PUT",a=>route("api.albums.photos.addMultiple",{album:a.album_id}),(a,r)=>route("albums.show",{album:r.album_id}));function u(a,r){const i={"photo.more":s=>r.showMore(),"photo.info":s=>r.viewInfo(s.detail.id),"photo.download":s=>r.forceDownload(s.detail.id)};for(const[s,o]of Object.entries(i))a.addEventListener(s,o)}function y(a,r){Object.entries({"grid.refresh":s=>r.refresh(s.detail),"selection.start":s=>r.disable(),"selection.stop":s=>r.enable()}).forEach(([s,o])=>{a.addEventListener(s,o)})}function P(a,r=".container-hidden"){const i=document.getElementById(a);i.addEventListener("show.bs.offcanvas",()=>{const s=t.querySelectorAll(".selected"),o=Array.from(s).map(h=>h.dataset.id),f=i.querySelector(r);f.innerHTML="",o.forEach(h=>{const m=document.createElement("input");m.name="pictures",m.type="hidden",m.value=h,f.appendChild(m)});const l=i.querySelector(".picture-count");l.textContent=o.length})}function w(a,r="POST",i,s){const o=document.getElementById(a);o.addEventListener("submit",async function(f){if(f.preventDefault(),!o.checkValidity())return o.reportValidity();try{const l=b(o),h=await d.request(i(l),r,l,"albums");o.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=s(h,l)},1e3)}catch(l){console.error(l)}}),o.reset()}});class S{constructor(t){this.selector=t,this.grid=new L(this),this.folderLoader=new x,this.photoLoader=new T}async init(){this.loading=!1;const t=await this.folderLoader.getFolder();this._setParent(t.parent_id),this._setName(t.name),this._setId(t.id),await this.showMore()}isLoading(){return this.loading}async showMore(){if(this.loading=!0,this.folderLoader.hasNextPage()){const e=(await this.folderLoader.next()).map(c=>{const u=p.folder(c,this);return u.addEventListener("click",async()=>{this.setFolder(c.id)}),u}),n=await Promise.all(e);this.grid.add(n)}if(!this.folderLoader.hasNextPage()){const e=(await this.photoLoader.next()).map(c=>p.photoFolder(c,this)),n=await Promise.all(e);this.grid.add(n)}this.loading=!1}async viewInfo(t){try{const e=route("api.photos.show",{photo:t}),n=await d.request(e,"GET");_(document.getElementById("infoForm"),{dimensions:`${n.data.width} x ${n.data.height}`,...n.data})}catch(e){console.error(e)}F("offcanvas-info")}forceDownload(t){const e=route("photos.download",{photo:t});window.location.href=e}async setFolder(t){this.selector.cancelSelection(),this.grid.clear(),this._setId(t),this.init()}_setName(t){document.getElementById("title").innerHTML=t}_setParent(t){if(t!=null){const e=p.folder({name:"Parent",id:t},this);e.addEventListener("click",async()=>{this.setFolder(t)}),this.grid.add(e)}this.parent=t}_setId(t){this.folderLoader.init(t),this.photoLoader.init(t)}}class x{constructor(){this.folderId=0,this.lastPage=null,this.currentPage=null}async init(t){this.folderId=t,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async getFolder(){try{return(await d.request(`/api/folders/${this.folderId}`,"GET",null,this.folderId)).data}catch(t){console.error(t)}return null}async _fetchPage(t=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const e=await d.request(`/api/folders/${this.folderId}/subfolders?page=${t}`,"GET",null,this.folderId);return this.currentPage=e.meta.current_page,this.lastPage=e.meta.last_page,e.data}catch(e){console.error(e)}return[]}}class T{constructor(t){this.folderId=t,this.lastPage=null,this.currentPage=0}async init(t){this.folderId=t,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(t=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const e=await d.request(`/api/folders/${this.folderId}/photos?page=${t}`,"GET",null,this.folderId);return this.currentPage=e.meta.current_page,this.lastPage=e.meta.last_page,e.data}catch(e){console.error(e)}return[]}}
