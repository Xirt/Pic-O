import{P}from"./PicoView-CWvvcuAP.js";import{S as I}from"./Selection-BoYlDC7p.js";import{A as c,g as L,p as v,o as w,t as b,r as q}from"./domHelpers-CinBHhEo.js";import{G as k,a as T}from"./Grid-tctQ46l5.js";document.addEventListener("DOMContentLoaded",async()=>{const m=document.getElementById("grid"),a=document.getElementById("album").dataset.albumId;new I(m);const o=new A(a),i=new P(m);o.init(),s(i,o),E(m,i);const l=document.getElementById("updateAlbumForm");l.addEventListener("submit",async function(n){n.preventDefault();try{await c.request(route("api.albums.update",{album:a}),"PATCH",L(l),"albums"),location.reload()}catch(t){console.error(t)}}),document.getElementById("offcanvasUpdateAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=route("api.albums.show",{album:a}),d=await c.request(t,"GET");v(document.getElementById("updateAlbumForm"),d.data)}catch(t){console.error(t)}w("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum").addEventListener("show.bs.offcanvas",async function(n){try{const t=p.getAttribute("data-album-id"),d=await c.request(route("api.albums.tokens",{album:t}),"GET"),e=document.getElementById("tokenList");d.data.forEach(u=>{e.appendChild(h(u))})}catch(t){console.error(t)}}),document.getElementById("multiDeleteBtn").addEventListener("click",async function(n){n.preventDefault();try{alert("Pending implementation")}catch(t){console.error(t)}});const p=document.getElementById("generateTokenBtn");p.addEventListener("click",async function(n){n.preventDefault();try{const t=p.getAttribute("data-album-id"),d=await c.request(route("api.tokens.store"),"POST",{album_id:t});document.getElementById("tokenList").appendChild(h(d.data))}catch(t){console.error(t)}});function h(n){const t=route("albums.show",{album:n.album_id,token:n.token}),e=document.getElementById("tokenTpl").content.cloneNode(!0);e.querySelector("input").value=t,e.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),e.querySelector(".expires_at").value=n.expires_at,e.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t):(f.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),b("Copied to clipboard")});const f=e.querySelector(".btn-delete");return f.addEventListener("click",()=>{c.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),f.closest(".token-wrapper").remove(),b("Share link has been deleted")}),e}function s(n,t){const d={"photo.more":e=>t.showMore(),"photo.info":e=>t.viewInfo(e.detail.id),"photo.cover":e=>t.setCover(e.detail.id),"photo.download":e=>t.forceDownload(e.detail.id),"photo.remove":e=>{t.remove(e.detail.id),n.next()},"photo.shown":e=>t.recordView(e.detail.id)};for(const[e,u]of Object.entries(d))n.addEventListener(e,u)}function E(n,t){Object.entries({"grid.refresh":e=>t.refresh(e.detail),"selection.start":e=>t.disable(),"selection.stop":e=>t.enable()}).forEach(([e,u])=>{n.addEventListener(e,u)})}});class A{constructor(a){this.id=a,this.grid=new k(this),this.loader=new S(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const o=(await this.loader.next()).map(async l=>{const r=await T.photo(l);return r.querySelector(".btn-delete").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.remove(l.id)}),r.querySelector(".btn-info").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.viewInfo(l.id)}),r.querySelector(".btn-cover").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.setCover(l.id)}),r.querySelector(".btn-download").addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.forceDownload(l.id)}),r}),i=await Promise.all(o);this.grid.add(i)}}async recordView(a){try{const o=route("api.photos.impression",{photo:a});await c.request(o,"POST")}catch(o){console.error(o)}}async viewInfo(a){try{const o=route("api.photos.show",{photo:a}),i=await c.request(o,"GET");v(document.getElementById("infoForm"),{dimensions:`${i.data.width} x ${i.data.height}`,...i.data})}catch(o){console.error(o)}w("offcanvas-info")}forceDownload(a){const o=route("photos.download",{photo:a});window.location.href=o}async setCover(a){try{const o=route("api.albums.update",{album:this.id});await c.request(o,"PATCH",{photo_id:a}),b("Album cover set")}catch(o){console.error(o)}}async remove(a){const o=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await c.request(r,"DELETE")}catch(r){console.error(r)}const i=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(o),i.show();const l=document.getElementById("btn-undo");q(l).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await c.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(o),i.hide()})}}class S{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||c.isLoading(this.albumId))return[];try{const o=await c.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=o.meta.current_page,this.lastPage=o.meta.last_page,o.data}catch(o){console.error(o)}return[]}}
