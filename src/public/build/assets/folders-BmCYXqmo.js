import{P as E}from"./PicoView-DydfquQH.js";import{S as F,a as p}from"./SelectionManager-d2m16iPx.js";import{g as I,A as d,p as v,o as L}from"./domHelpers-DvNThchU.js";import{G as _,a as P}from"./Grid-DsGZyy7Q.js";let y;document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("grid"),t=new S(new F(e)),n=new E(e);t.init(),c(n,t),h(e,n),addFolderFolder=new p({container:"addFolderFolder",apiUrl:route("api.folders.search")}),new p({container:"addFolderAlbum",apiUrl:route("api.albums.search")}),m("addFolderToAlbumForm","PUT",a=>route("api.albums.photos.addFromFolder",{album:a.album_id}),(a,s)=>route("albums.show",{album:s.album_id})),b("offcanvas-add-selection-to-album"),new p({container:"addSelectionAlbum",apiUrl:route("api.albums.search")}),m("addSelectionToAlbumForm","PUT",a=>route("api.albums.photos.addMultiple",{album:a.album_id}),(a,s)=>route("albums.show",{album:s.album_id})),y=new p({container:"createAlbumFromFolder",apiUrl:route("api.folders.search")}),m("createAlbumFromFolderForm","POST",a=>route("api.albums.storeFromFolder"),a=>route("albums.show",{album:a.data.id})),b("offcanvas-create-album-from-selection"),m("createAlbumFromSelectionForm","POST",a=>route("api.albums.store"),a=>route("albums.show",{album:a.data.id}));function c(a,s){const l={"photo.more":r=>s.showMore(),"photo.info":r=>s.viewInfo(r.detail.id),"photo.download":r=>s.forceDownload(r.detail.id)};for(const[r,o]of Object.entries(l))a.addEventListener(r,o)}function h(a,s){Object.entries({"grid.refresh":r=>s.refresh(r.detail),"selection.start":r=>s.disable(),"selection.stop":r=>s.enable()}).forEach(([r,o])=>{a.addEventListener(r,o)})}function b(a,s=".container-hidden"){const l=document.getElementById(a);l.addEventListener("show.bs.offcanvas",()=>{const r=e.querySelectorAll(".selected"),o=Array.from(r).map(u=>u.dataset.id),f=l.querySelector(s);f.innerHTML="",o.forEach(u=>{const g=document.createElement("input");g.name="pictures",g.type="hidden",g.value=u,f.appendChild(g)});const i=l.querySelector(".picture-count");i.textContent=o.length})}function m(a,s="POST",l,r){const o=document.getElementById(a);o.addEventListener("submit",async function(f){if(f.preventDefault(),!o.checkValidity())return o.reportValidity();o.querySelectorAll("button").forEach(i=>i.disabled=!0);try{const i=I(o),u=await d.request(l(i),s,i,"albums");o.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=r(u,i)},1e3)}catch(i){console.error(i)}}),o.reset()}});class S{constructor(e){this.selector=e,this.grid=new _(this),this.folderLoader=new T,this.photoLoader=new A}async init(){this.loading=!1;const e=await this.folderLoader.getFolder();this._setParent(e.parent_id),this._setName(e.name),this._setId(e.id),await this.showMore()}isLoading(){return this.loading}async showMore(){if(this.loading=!0,this.folderLoader.hasNextPage()){const t=(await this.folderLoader.next()).map(c=>{const h=P.folder(c,this);return h.addEventListener("click",async()=>{this.setFolder(c.id)}),h}),n=await Promise.all(t);this.grid.add(n)}if(!this.folderLoader.hasNextPage()){const t=(await this.photoLoader.next()).map(c=>P.file(c,this)),n=await Promise.all(t);this.grid.add(n)}this.loading=!1}async viewInfo(e){try{const t=route("api.photos.show",{photo:e}),n=await d.request(t,"GET");v(document.getElementById("infoForm"),{dimensions:`${n.data.width} x ${n.data.height}`,...n.data})}catch(t){console.error(t)}L("offcanvas-info")}forceDownload(e){const t=route("photos.download",{photo:e});window.location.href=t}async setFolder(e){this.selector.cancelSelection(),this.grid.clear(),this._setId(e),this.init()}_setName(e){document.getElementById("title").innerHTML=e}_setParent(e){if(e!=null){const t=P.folder({name:"Parent",id:e},this);t.addEventListener("click",async()=>{this.setFolder(e)}),this.grid.add(t)}this.parent=e}_setId(e){this.folderLoader.init(e),this.photoLoader.init(e)}}class T{constructor(){this.folderId=0,this.lastPage=null,this.currentPage=null}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async getFolder(){try{const e=await d.request(`/api/folders/${this.folderId}`,"GET",null,this.folderId);return y.setItem(e.data.id,e.data.name),addFolderFolder.setItem(e.data.id,e.data.name),e.data}catch(e){console.error(e)}return null}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/subfolders?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}class A{constructor(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async init(e){this.folderId=e,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(e=1){if(this.folderId==null||d.isLoading(this.folderId))return[];try{const t=await d.request(`/api/folders/${this.folderId}/photos?page=${e}`,"GET",null,this.folderId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
