import{P as k}from"./PicoView-DB6ceu55.js";import{S as T,a as x}from"./SelectionManager-CW6oMzqK.js";import{g as D,A as l,p as q,o as w,f as P,t as y,r as L}from"./domHelpers-fLsed4VC.js";import{G as C,a as _}from"./Grid-534rpfpb.js";document.addEventListener("DOMContentLoaded",async()=>{const a=document.getElementById("grid"),t=document.getElementById("album").dataset.albumId;new T(a);const c=new F(t),d=new k(a);c.init(),A(d,c),S(a,d),new x({container:"addFolderFolder",apiUrl:route("api.folders.search")}),r("addFolderToAlbumForm","PUT",n=>route("api.albums.photos.addFromFolder",{album:n.album_id}),(n,o)=>route("albums.show",{album:o.album_id})),r("updateAlbumForm","PATCH",n=>route("api.albums.update",{album:t}),(n,o)=>window.location.href);function r(n,o="POST",u,e){const s=document.getElementById(n);s?.addEventListener("submit",async function(v){if(v.preventDefault(),!s.checkValidity())return s.reportValidity();s.querySelectorAll("button").forEach(m=>m.disabled=!0);try{const m=D(s),p=await l.request(u(m),o,m);s.querySelector(".form-message")?.classList.add("visible"),setTimeout(()=>{window.location.href=e(p,m)},1e3)}catch(m){console.error(m)}}),s?.reset()}document.getElementById("offcanvasUpdateAlbum")?.addEventListener("show.bs.offcanvas",async function(n){try{const o=route("api.albums.show",{album:t}),u=await l.request(o,"GET");q(document.getElementById("updateAlbumForm"),u.data)}catch(o){console.error(o)}w("offcanvasUpdateAlbum")}),document.getElementById("offcanvasShareAlbum")?.addEventListener("show.bs.offcanvas",async function(n){try{const o=b.getAttribute("data-album-id"),u=await l.request(route("api.albums.tokens",{album:o}),"GET"),e=document.getElementById("tokenList");e.querySelectorAll(".token-wrapper").forEach(s=>s.remove()),u.data.forEach(s=>{e.appendChild(i(s))})}catch(o){console.error(o)}}),document.getElementById("multiDeleteBtn")?.addEventListener("click",async function(n){const o=document.querySelectorAll(".grid-item.selected");c.showRemovalconfirmation(o),n.preventDefault()});const b=document.getElementById("generateTokenBtn");b?.addEventListener("click",async function(n){n.preventDefault();try{const o=b.getAttribute("data-album-id"),u=await l.request(route("api.tokens.store"),"POST",{album_id:o});document.getElementById("tokenList").appendChild(i(u.data))}catch(o){console.error(o)}});function i(n){const o=route("albums.show",{album:n.album_id,token:n.token}),e=document.getElementById("tokenTpl").content.cloneNode(!0);e.querySelector("input").value=o,e.querySelector(".expiry").classList.toggle("d-none",!n.expires_at),e.querySelector(".expires_at").textContent=P(n.expires_at),e.querySelector(".date-picker").value=n.expires_at,e.querySelector(".btn-copy").addEventListener("click",()=>{navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(o):(m.closest(".token-wrapper").querySelector("input").select(),document.execCommand("copy")),y("Copied to clipboard")});const v=e.querySelector(".btn-calendar");v.addEventListener("click",()=>{const p=v.previousElementSibling;p.addEventListener("change",async()=>{const g=(await l.request(route("api.tokens.update",{expires_at:p.value,token:n.id}),"PATCH")).data,B=v.closest(".token-wrapper");B.querySelector(".expiry").classList.toggle("d-none",!g.expires_at),B.querySelector(".expires_at").textContent=P(g.expires_at)},{once:!0}),p.showPicker?.(),p.focus()});const m=e.querySelector(".btn-delete");return m.addEventListener("click",()=>{l.request(route("api.tokens.destroy",{token:n.id}),"DELETE"),m.closest(".token-wrapper").remove(),y("Share link has been deleted")}),e}function A(n,o){const u={"photo.more":e=>o.showMore(),"photo.info":e=>o.viewInfo(e.detail.id),"photo.cover":e=>o.setCover(e.detail.id),"photo.download":e=>o.forceDownload(e.detail.id),"photo.remove":e=>{o.remove(e.detail.id),n.next()},"photo.shown":e=>o.recordView(e.detail.id)};for(const[e,s]of Object.entries(u))n.addEventListener(e,s)}function S(n,o){Object.entries({"grid.refresh":e=>o.refresh(e.detail),"selection.start":e=>o.disable(),"selection.stop":e=>o.enable()}).forEach(([e,s])=>{n.addEventListener(e,s)})}});class F{constructor(a){this.id=a,this.grid=new C(this),this.loader=new O(a)}async init(){this.grid.clear(),await this.showMore()}async showMore(){if(this.loader.hasNextPage()){const t=(await this.loader.next()).map(async d=>{const r=await _.photo(d);return r.querySelector(".btn-delete")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.remove(d.id)}),r.querySelector(".btn-info")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.viewInfo(d.id)}),r.querySelector(".btn-cover")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.setCover(d.id)}),r.querySelector(".btn-download")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.forceDownload(d.id)}),r}),c=await Promise.all(t);this.grid.add(c)}}async recordView(a){try{const t=route("api.photos.impression",{photo:a});await l.request(t,"POST")}catch(t){console.error(t)}}async viewInfo(a){try{const t=route("api.photos.show",{photo:a}),c=await l.request(t,"GET");q(document.getElementById("infoForm"),{dimensions:`${c.data.width} x ${c.data.height}`,...c.data})}catch(t){console.error(t)}w("offcanvas-info")}forceDownload(a){const t=route("photos.download",{photo:a});window.location.href=t}async setCover(a){try{const t=route("api.albums.update",{album:this.id});await l.request(t,"PATCH",{photo_id:a}),y("Album cover set")}catch(t){console.error(t)}}async remove(a){const t=document.getElementById(`card-${a}`);try{const r=route("api.albums.photos.removeOne",{album:this.id,photo:a});await l.request(r,"DELETE")}catch(r){console.error(r)}const c=new bootstrap.Toast(document.getElementById("removalToast"),{animation:!0,autohide:!0,delay:4e3});this.grid.remove(t),c.show();const d=document.getElementById("btn-undo");L(d).addEventListener("click",async()=>{try{const r=route("api.albums.photos.addOne",{album:this.id,photo:a});await l.request(r,"PUT")}catch(r){console.error(r)}this.grid.add(t),c.hide()})}showRemovalconfirmation(a){const t=Array.isArray(a)?a:a instanceof NodeList?Array.from(a):[a],c=document.getElementById("delCount");c.textContent=t.length;const d=w("offcanvasRemovePhotos");let r=document.getElementById("btn-remove");L(r).addEventListener("click",()=>{try{const h=route("api.albums.photos.removeMultiple",{album:this.id});l.request(h,"DELETE",{pictures:t.map(f=>f.getAttribute("data-id"))});for(const f of t)this.grid.remove(f);y("Photo(s) removed")}catch(h){console.log(h)}d.hide()})}}class O{constructor(a){this.albumId=a,this.lastPage=null,this.currentPage=0}async start(){return this.currentPage=0,await this.next()}hasNextPage(){return this.lastPage==null||this.currentPage<this.lastPage}async next(){return this.hasNextPage()?await this._fetchPage(this.currentPage+1):[]}async _fetchPage(a=1){if(this.albumId==null||l.isLoading(this.albumId))return[];try{const t=await l.request(`/api/albums/${this.albumId}/photos?page=${a}`,"GET",null,this.albumId);return this.currentPage=t.meta.current_page,this.lastPage=t.meta.last_page,t.data}catch(t){console.error(t)}return[]}}
